<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Create and share one-time secrets securely with Hakanai - zero-knowledge secret sharing"
      data-i18n-content="meta.create"
    />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; upgrade-insecure-requests"
    />
    <link rel="icon" type="image/svg+xml" href="/icon.svg" />
    <title data-i18n-title="page.create.title">Hakanai - Create Secret</title>
    <link rel="stylesheet" href="/style.css" />
    <script src="/i18n.js"></script>
  </head>
  <body>
    <main class="container">
      <header class="header">
        <img src="/logo.svg" alt="Logo" width="200" height="60" />
        <select id="language-switcher" aria-label="Language"></select>
      </header>
      <section aria-labelledby="main-heading">
        <h1 id="main-heading" data-i18n="header.create">Create Secret</h1>
        <form onsubmit="event.preventDefault(); createSecret();" novalidate>
          <div class="input-group">
            <label for="secretText" data-i18n="label.secret"
              >Enter your secret:</label
            >
            <textarea
              id="secretText"
              placeholder="Enter your secret message here..."
              data-i18n-placeholder="placeholder.secret"
              aria-describedby="secret-help"
              required
              autocomplete="off"
              spellcheck="false"
              rows="4"
              style="
                width: 100%;
                padding: var(--spacing-sm) var(--spacing-md);
                border: 1px solid var(--color-border);
                border-radius: var(--border-radius);
                font-size: var(--font-size-sm);
                background-color: var(--color-bg-main);
                color: var(--color-text);
                transition: border-color var(--transition-fast);
                font-family: var(--font-mono);
                resize: vertical;
                min-height: 5rem;
              "
            ></textarea>
            <span id="secret-help" class="sr-only" data-i18n="aria.secretInput"
              >Enter the secret message you want to share securely</span
            >
          </div>
          <div class="input-group">
            <label for="authToken" data-i18n="label.token"
              >Authentication Token:</label
            >
            <input
              id="authToken"
              type="password"
              placeholder="Enter authentication token (leave empty if none required)"
              data-i18n-placeholder="placeholder.token"
              aria-describedby="token-help"
              autocomplete="off"
              style="
                width: 100%;
                padding: var(--spacing-sm) var(--spacing-md);
                border: 1px solid var(--color-border);
                border-radius: var(--border-radius);
                font-size: var(--font-size-sm);
                background-color: var(--color-bg-main);
                color: var(--color-text);
                transition: border-color var(--transition-fast);
                font-family: var(--font-mono);
              "
            />
            <span id="token-help" class="sr-only" data-i18n="aria.tokenInput"
              >Enter the authentication token if required by the server</span
            >
          </div>
          <div class="input-group">
            <label for="ttlSelect" data-i18n="label.expires"
              >Expires after:</label
            >
            <select
              id="ttlSelect"
              aria-describedby="ttl-help"
              style="
                width: 100%;
                padding: var(--spacing-sm) var(--spacing-md);
                border: 1px solid var(--color-border);
                border-radius: var(--border-radius);
                font-size: var(--font-size-sm);
                background-color: var(--color-bg-main);
                color: var(--color-text);
                transition: border-color var(--transition-fast);
              "
            >
              <option value="300" data-i18n="time.5min">5 minutes</option>
              <option value="1800" data-i18n="time.30min">30 minutes</option>
              <option value="3600" selected data-i18n="time.1hour">
                1 hour
              </option>
              <option value="7200" data-i18n="time.2hours">2 hours</option>
              <option value="43200" data-i18n="time.12hours">12 hours</option>
              <option value="86400" data-i18n="time.24hours">24 hours</option>
              <option value="604800" data-i18n="time.7days">7 days</option>
            </select>
            <span id="ttl-help" class="sr-only" data-i18n="aria.expiresSelect"
              >Select how long the secret should be available before it
              expires</span
            >
          </div>
          <button type="submit" id="createBtn" data-i18n="button.create">
            Create Secret
          </button>
        </form>
        <div class="loading" id="loading" role="status" aria-live="polite">
          <div class="spinner" aria-hidden="true"></div>
          <span data-i18n="msg.creating">Creating secret...</span>
        </div>
        <div
          id="result"
          role="region"
          aria-live="polite"
          aria-atomic="true"
        ></div>
      </section>
      <footer class="footer">
        <a
          href="https://github.com/czerwonk/hakanai"
          target="_blank"
          rel="noopener noreferrer"
          data-i18n="link.github"
          >View on GitHub</a
        >
      </footer>
    </main>
    <noscript>
      <div class="container">
        <div class="result error">
          <h3 data-i18n="msg.jsRequired">JavaScript Required</h3>
          <p data-i18n="msg.jsRequiredDetail">
            This application requires JavaScript to encrypt secrets securely in
            your browser.
          </p>
        </div>
      </div>
    </noscript>

    <script src="/scripts/hakanai-client.js"></script>
    <script>
      // Listen for language changes to update dynamic content
      document.addEventListener("languageChanged", function (e) {
        updateUIStrings();
      });

      function updateUIStrings() {
        UI_STRINGS.EMPTY_SECRET = i18n.t("msg.emptySecret");
        UI_STRINGS.CREATE_FAILED = i18n.t("msg.createFailed");
        UI_STRINGS.SUCCESS_TITLE = i18n.t("msg.successTitle");
        UI_STRINGS.ERROR_TITLE = i18n.t("msg.errorTitle");
        UI_STRINGS.COPY_TEXT = i18n.t("button.copy");
        UI_STRINGS.COPIED_TEXT = i18n.t("button.copied");
        UI_STRINGS.COPY_FAILED = i18n.t("msg.copyFailed");
        UI_STRINGS.NOTE_TEXT = i18n.t("msg.createNote");
        UI_STRINGS.SHARE_INSTRUCTIONS = i18n.t("msg.shareInstructions");
      }

      const UI_STRINGS = {
        EMPTY_SECRET: "Please enter a secret to share",
        CREATE_FAILED: "Failed to create secret",
        SUCCESS_TITLE: "Secret Created Successfully",
        ERROR_TITLE: "Error",
        COPY_TEXT: "Copy URL",
        COPIED_TEXT: "Copied!",
        COPY_FAILED: "Failed to copy. Please select and copy manually.",
        NOTE_TEXT:
          "Note: Share this URL carefully. The secret will be deleted after the first access or when it expires.",
        SHARE_INSTRUCTIONS:
          "Share this URL with the intended recipient. The secret is encrypted and can only be accessed once.",
      };

      const TIMEOUTS = {
        COPY_FEEDBACK: 2000,
      };

      // Extract base URL from current location or use a default
      const baseUrl = window.location.origin.includes("file://")
        ? "http://localhost:8080"
        : window.location.origin;

      const client = new HakanaiClient(baseUrl);

      async function createSecret() {
        const secretInput = document.getElementById("secretText");
        const authTokenInput = document.getElementById("authToken");
        const ttlSelect = document.getElementById("ttlSelect");
        const resultDiv = document.getElementById("result");
        const loadingDiv = document.getElementById("loading");
        const button = document.getElementById("createBtn");

        const secret = secretInput.value.trim();
        const authToken = authTokenInput.value.trim();
        const ttl = parseInt(ttlSelect.value);

        if (!secret) {
          showError(UI_STRINGS.EMPTY_SECRET);
          secretInput.focus();
          return;
        }

        // Show loading state
        loadingDiv.style.display = "block";
        button.disabled = true;
        secretInput.disabled = true;
        authTokenInput.disabled = true;
        ttlSelect.disabled = true;
        resultDiv.innerHTML = "";

        try {
          const secretUrl = await client.sendSecret(secret, ttl, authToken);

          showSuccess(secretUrl);

          // Clear the input
          secretInput.value = "";
        } catch (error) {
          showError(error.message || UI_STRINGS.CREATE_FAILED);
        } finally {
          loadingDiv.style.display = "none";
          button.disabled = false;
          secretInput.disabled = false;
          authTokenInput.disabled = false;
          ttlSelect.disabled = false;
        }
      }

      function showSuccess(secretUrl) {
        const resultDiv = document.getElementById("result");
        resultDiv.className = "result success";
        const urlId = "url-" + Date.now();

        resultDiv.innerHTML = "";

        // Create elements programmatically to avoid XSS
        const title = document.createElement("h3");
        title.textContent = UI_STRINGS.SUCCESS_TITLE;
        resultDiv.appendChild(title);

        const instructions = document.createElement("p");
        instructions.style.marginBottom = "var(--spacing-md)";
        instructions.style.fontSize = "var(--font-size-sm)";
        instructions.style.color = "var(--color-text-muted)";
        instructions.textContent = UI_STRINGS.SHARE_INSTRUCTIONS;
        resultDiv.appendChild(instructions);

        const container = document.createElement("div");
        container.className = "secret-container";

        const urlDisplay = document.createElement("input");
        urlDisplay.type = "text";
        urlDisplay.id = urlId;
        urlDisplay.readOnly = true;
        urlDisplay.setAttribute("aria-label", "Secret URL");
        urlDisplay.value = secretUrl;
        urlDisplay.style.fontFamily = "var(--font-mono)";
        urlDisplay.style.fontSize = "var(--font-size-sm)";
        urlDisplay.addEventListener("click", function () {
          this.select();
        });
        container.appendChild(urlDisplay);

        const buttonsContainer = document.createElement("div");
        buttonsContainer.className = "buttons-container";

        const copyBtn = document.createElement("button");
        copyBtn.className = "copy-button";
        copyBtn.type = "button";
        copyBtn.textContent = UI_STRINGS.COPY_TEXT;
        copyBtn.setAttribute("aria-label", "Copy secret URL to clipboard");
        copyBtn.addEventListener("click", function () {
          copyUrl(urlId, this);
        });
        buttonsContainer.appendChild(copyBtn);

        container.appendChild(buttonsContainer);

        resultDiv.appendChild(container);

        const note = document.createElement("p");
        note.style.marginTop = "var(--spacing-sm, 0.75rem)";
        note.style.fontSize = "0.875rem";
        note.style.color = "var(--color-text-muted, #888888)";

        // Create strong element for "Note:" text
        const strong = document.createElement("strong");
        strong.textContent = i18n.t("msg.createNote").split(":")[0] + ":";
        note.appendChild(strong);

        // Add the rest of the text
        note.appendChild(
          document.createTextNode(" " + i18n.t("msg.createNoteText")),
        );
        resultDiv.appendChild(note);

        // Announce to screen readers
        announceToScreenReader(UI_STRINGS.SUCCESS_TITLE);
      }

      function showError(message) {
        const resultDiv = document.getElementById("result");
        resultDiv.className = "result error";

        // Clear existing content
        resultDiv.innerHTML = "";

        // Create elements programmatically to avoid XSS
        const title = document.createElement("h3");
        title.textContent = UI_STRINGS.ERROR_TITLE;
        resultDiv.appendChild(title);

        const errorDiv = document.createElement("div");
        errorDiv.textContent = message;
        resultDiv.appendChild(errorDiv);

        // Announce error to screen readers
        announceToScreenReader(`${UI_STRINGS.ERROR_TITLE}: ${message}`);
      }

      function copyUrl(urlId, button) {
        const urlElement = document.getElementById(urlId);
        const originalText = button.textContent;

        // Get the actual URL text from input value
        const urlText = urlElement.value;

        if (navigator.clipboard && navigator.clipboard.writeText) {
          // Modern clipboard API
          navigator.clipboard
            .writeText(urlText)
            .then(() => {
              button.textContent = UI_STRINGS.COPIED_TEXT;
              button.classList.add("copied");
              announceToScreenReader(UI_STRINGS.COPIED_TEXT);
              setTimeout(() => {
                button.textContent = originalText;
                button.classList.remove("copied");
              }, TIMEOUTS.COPY_FEEDBACK);
            })
            .catch((err) => {
              // Fallback to older method
              fallbackCopy(urlText, button, originalText);
            });
        } else {
          // Fallback for older browsers
          fallbackCopy(urlText, button, originalText);
        }
      }

      function fallbackCopy(text, button, originalText) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          document.execCommand("copy");
          button.textContent = UI_STRINGS.COPIED_TEXT;
          button.classList.add("copied");
          announceToScreenReader(UI_STRINGS.COPIED_TEXT);
          setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove("copied");
          }, TIMEOUTS.COPY_FEEDBACK);
        } catch (err) {
          alert(UI_STRINGS.COPY_FAILED);
        }

        document.body.removeChild(textArea);
      }

      // Focus on the secret input when page loads
      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("secretText").focus();
        // Initialize UI strings after i18n is loaded
        updateUIStrings();
      });

      // Accessibility helper
      function announceToScreenReader(message) {
        const announcement = document.createElement("div");
        announcement.setAttribute("role", "status");
        announcement.setAttribute("aria-live", "polite");
        announcement.className = "sr-only";
        announcement.textContent = message;
        document.body.appendChild(announcement);

        // Remove after announcement
        setTimeout(() => {
          document.body.removeChild(announcement);
        }, 1000);
      }
    </script>
  </body>
</html>
